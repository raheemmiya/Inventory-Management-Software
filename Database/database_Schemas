-- Debt Management Database Schema
-- Add this to your existing garage_inventory database

USE garage_inventory;

-- Debt Transactions table
-- Tracks all credit sales and customer debts
CREATE TABLE IF NOT EXISTS debt_transactions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL,
    sale_id INT,  -- Link to original sale if debt is from a sale
    transaction_type ENUM('CREDIT_SALE', 'PAYMENT', 'ADJUSTMENT') NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    remaining_balance DECIMAL(10, 2) NOT NULL,
    transaction_date DATE NOT NULL,
    due_date DATE,
    payment_method VARCHAR(50),  -- 'CASH', 'BANK_TRANSFER', 'CHEQUE', etc.
    reference_number VARCHAR(100),  -- Invoice/Receipt/Cheque number
    notes TEXT,
    status ENUM('PENDING', 'PARTIAL', 'PAID', 'OVERDUE') DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FOREIGN KEY (sale_id) REFERENCES sales(id) ON DELETE SET NULL
);

-- Payment History table
-- Tracks individual payments made against debts
CREATE TABLE IF NOT EXISTS debt_payments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    debt_transaction_id INT NOT NULL,
    payment_amount DECIMAL(10, 2) NOT NULL,
    payment_date DATE NOT NULL,
    payment_method VARCHAR(50) NOT NULL,
    reference_number VARCHAR(100),
    notes TEXT,
    created_by VARCHAR(50) DEFAULT 'admin',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (debt_transaction_id) REFERENCES debt_transactions(id) ON DELETE CASCADE
);

-- Customer Credit Limit table
-- Optional: Set credit limits for customers
CREATE TABLE IF NOT EXISTS customer_credit_limits (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT UNIQUE NOT NULL,
    credit_limit DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
    current_balance DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE
);

-- Create indexes for better performance
CREATE INDEX idx_debt_customer ON debt_transactions(customer_id);
CREATE INDEX idx_debt_status ON debt_transactions(status);
CREATE INDEX idx_debt_date ON debt_transactions(transaction_date);
CREATE INDEX idx_payment_debt ON debt_payments(debt_transaction_id);

-- Create a view for easier debt summary queries
CREATE OR REPLACE VIEW debt_summary AS
SELECT
    c.id as customer_id,
    c.name as customer_name,
    c.contact_number,
    COUNT(dt.id) as total_transactions,
    SUM(CASE WHEN dt.transaction_type = 'CREDIT_SALE' THEN dt.amount ELSE 0 END) as total_credit,
    SUM(CASE WHEN dt.transaction_type = 'PAYMENT' THEN dt.amount ELSE 0 END) as total_payments,
    SUM(dt.remaining_balance) as outstanding_balance,
    MIN(CASE WHEN dt.status IN ('PENDING', 'PARTIAL', 'OVERDUE') THEN dt.transaction_date END) as oldest_debt_date,
    COUNT(CASE WHEN dt.status = 'OVERDUE' THEN 1 END) as overdue_count
FROM customers c
LEFT JOIN debt_transactions dt ON c.id = dt.customer_id
GROUP BY c.id, c.name, c.contact_number;



-- Migration script to add customers table and update sales table
-- Run this if you already have an existing database
-- Note: This script assumes the customer_id column doesn't exist yet

USE garage_inventory;

-- Create customers table
CREATE TABLE IF NOT EXISTS customers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    contact_number VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    vehicle_info VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Check if customer_id column exists, if not add it
-- Note: If you get an error saying column already exists, skip this step
SET @dbname = DATABASE();
SET @tablename = 'sales';
SET @columnname = 'customer_id';
SET @preparedStatement = (SELECT IF(
  (
    SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS
    WHERE
      (table_name = @tablename)
      AND (table_schema = @dbname)
      AND (column_name = @columnname)
  ) > 0,
  'SELECT 1',
  CONCAT('ALTER TABLE ', @tablename, ' ADD COLUMN ', @columnname, ' INT')
));
PREPARE alterIfNotExists FROM @preparedStatement;
EXECUTE alterIfNotExists;
DEALLOCATE PREPARE alterIfNotExists;

-- Add foreign key constraint (drop first if it exists to avoid errors)
SET @constraint_name = 'fk_sales_customer';
SET @preparedStatement = (SELECT IF(
  (
    SELECT COUNT(*) FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
    WHERE
      (TABLE_SCHEMA = @dbname)
      AND (TABLE_NAME = @tablename)
      AND (CONSTRAINT_NAME = @constraint_name)
  ) > 0,
  'SELECT 1',
  CONCAT('ALTER TABLE ', @tablename, ' ADD CONSTRAINT ', @constraint_name,
         ' FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE SET NULL')
));
PREPARE addConstraintIfNotExists FROM @preparedStatement;
EXECUTE addConstraintIfNotExists;
DEALLOCATE PREPARE addConstraintIfNotExists;

-- Optional: Drop customer_name column if it exists
-- Uncomment the lines below if you want to remove the old customer_name column
-- (Make sure to migrate any existing customer_name data to customers table first)
-- ALTER TABLE sales DROP COLUMN customer_name;



-- Garage Inventory Management System Database Schema
-- MySQL Database Schema

CREATE DATABASE IF NOT EXISTS garage_inventory;
USE garage_inventory;

-- Admin table (single admin account)
CREATE TABLE IF NOT EXISTS admin (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL
);

-- Insert default admin (username: admin, password: admin123)
-- In production, this should be hashed
INSERT INTO admin (username, password) VALUES ('admin', 'admin123');

-- Suppliers table
CREATE TABLE IF NOT EXISTS suppliers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    contact_number VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Items/Spare Parts table
CREATE TABLE IF NOT EXISTS items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    part_number VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    category VARCHAR(50),
    unit_price DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
    stock_quantity INT NOT NULL DEFAULT 0,
    min_stock_level INT NOT NULL DEFAULT 5,
    location VARCHAR(100),
    supplier_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE SET NULL
);

-- Purchases table
CREATE TABLE IF NOT EXISTS purchases (
    id INT PRIMARY KEY AUTO_INCREMENT,
    item_id INT NOT NULL,
    supplier_id INT,
    quantity INT NOT NULL,
    unit_price DECIMAL(10, 2) NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    purchase_date DATE NOT NULL,
    invoice_number VARCHAR(50),
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE,
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE SET NULL
);

-- Customers table
CREATE TABLE IF NOT EXISTS customers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    contact_number VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    vehicle_info VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Sales table
CREATE TABLE IF NOT EXISTS sales (
    id INT PRIMARY KEY AUTO_INCREMENT,
    item_id INT NOT NULL,
    customer_id INT,
    quantity INT NOT NULL,
    unit_price DECIMAL(10, 2) NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    sale_date DATE NOT NULL,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE SET NULL
);

-- Supplier-Item relationship (many-to-many, to track which items each supplier provides)
CREATE TABLE IF NOT EXISTS supplier_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    supplier_id INT NOT NULL,
    item_id INT NOT NULL,
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE CASCADE,
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE,
    UNIQUE KEY unique_supplier_item (supplier_id, item_id)
);

